name: "CI - Test Features"
on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Latest devcontainer CLI
        run: npm install -g @devcontainers/cli
      - name: Run Tests
        run: devcontainer features test --skip-autogenerated .
  publish:
    needs: test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v3
      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli
      - name: Install Cloudsmith CLI
        run: pip install --upgrade cloudsmith-cli
      - name: Publish to Cloudsmith
        run: |
          devcontainer features package src
          $Tarballs = Get-ChildItem -Path "output" -Filter "*.tgz"
          foreach ($Tarball in $Tarballs) {
            cloudsmith push raw ${{ github.repository }} $($Tarball.FullName)
          }
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_KEY }}